<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>RocketMQ源码解析——服务发现 | Floweryu</title><meta name="description" content="Good Good Study, Day Day On!">
    <link rel="modulepreload" href="/assets/app-9b3d3f60.js"><link rel="modulepreload" href="/assets/RocketMQyuanmajiexi——fuwufaxian.html-b997c296.js"><link rel="modulepreload" href="/assets/RocketMQyuanmajiexi——fuwufaxian.html-9620d4c4.js"><link rel="prefetch" href="/assets/index.html-0a05feab.js" as="script"><link rel="prefetch" href="/assets/index.html-8c2edf06.js" as="script"><link rel="prefetch" href="/assets/index.html-4b3ba946.js" as="script"><link rel="prefetch" href="/assets/index.html-4aad517b.js" as="script"><link rel="prefetch" href="/assets/index.html-2c2b70b4.js" as="script"><link rel="prefetch" href="/assets/index.html-142a6c11.js" as="script"><link rel="prefetch" href="/assets/index.html-c8ae5169.js" as="script"><link rel="prefetch" href="/assets/index.html-e1350560.js" as="script"><link rel="prefetch" href="/assets/index.html-172c7f9e.js" as="script"><link rel="prefetch" href="/assets/index.html-d9fc7521.js" as="script"><link rel="prefetch" href="/assets/index.html-1051f864.js" as="script"><link rel="prefetch" href="/assets/index.html-e1595639.js" as="script"><link rel="prefetch" href="/assets/index.html-3e0c5a31.js" as="script"><link rel="prefetch" href="/assets/index.html-771ddcb7.js" as="script"><link rel="prefetch" href="/assets/index.html-884db77f.js" as="script"><link rel="prefetch" href="/assets/index.html-a9219e6e.js" as="script"><link rel="prefetch" href="/assets/index.html-43bb3cc6.js" as="script"><link rel="prefetch" href="/assets/index.html-7916cad2.js" as="script"><link rel="prefetch" href="/assets/index.html-6d027d6f.js" as="script"><link rel="prefetch" href="/assets/index.html-3e3f8d15.js" as="script"><link rel="prefetch" href="/assets/index.html-b8452159.js" as="script"><link rel="prefetch" href="/assets/index.html-778b1084.js" as="script"><link rel="prefetch" href="/assets/index.html-3b21e310.js" as="script"><link rel="prefetch" href="/assets/index.html-ba5f9e82.js" as="script"><link rel="prefetch" href="/assets/index.html-b9cfbbcc.js" as="script"><link rel="prefetch" href="/assets/index.html-82aae14c.js" as="script"><link rel="prefetch" href="/assets/index.html-222b7f52.js" as="script"><link rel="prefetch" href="/assets/index.html-c6ca4148.js" as="script"><link rel="prefetch" href="/assets/index.html-c9a95ac2.js" as="script"><link rel="prefetch" href="/assets/index.html-f3448c09.js" as="script"><link rel="prefetch" href="/assets/index.html-48dc5b95.js" as="script"><link rel="prefetch" href="/assets/index.html-c67b10aa.js" as="script"><link rel="prefetch" href="/assets/index.html-4ff37064.js" as="script"><link rel="prefetch" href="/assets/index.html-cf1195f1.js" as="script"><link rel="prefetch" href="/assets/index.html-8acf3d9e.js" as="script"><link rel="prefetch" href="/assets/index.html-29ea95d5.js" as="script"><link rel="prefetch" href="/assets/index.html-6cf06f14.js" as="script"><link rel="prefetch" href="/assets/index.html-1a88d37b.js" as="script"><link rel="prefetch" href="/assets/index.html-c8e98ed0.js" as="script"><link rel="prefetch" href="/assets/index.html-800887e5.js" as="script"><link rel="prefetch" href="/assets/index.html-06f5ab5e.js" as="script"><link rel="prefetch" href="/assets/index.html-a35b7a92.js" as="script"><link rel="prefetch" href="/assets/Dubbochaoshishijianyuanli.html-aef89487.js" as="script"><link rel="prefetch" href="/assets/AQSyuanmalijie——ReentrantLock.html-fa0b1ee8.js" as="script"><link rel="prefetch" href="/assets/JVMcanshuxiangjie.html-efe91a07.js" as="script"><link rel="prefetch" href="/assets/JVMlajihuishouqi.html-b97f3f62.js" as="script"><link rel="prefetch" href="/assets/JVMlajihuishoujichu.html-e9087ced.js" as="script"><link rel="prefetch" href="/assets/Javade__heequals()dequbie.html-2c7b51b1.js" as="script"><link rel="prefetch" href="/assets/ThreadLocalyuanmaxiangjie.html-4f10a8d9.js" as="script"><link rel="prefetch" href="/assets/LIMITfenyeyouhuachaxun.html-badbee02.js" as="script"><link rel="prefetch" href="/assets/MQjianjie.html-7af90504.js" as="script"><link rel="prefetch" href="/assets/RocketMQkuangjiajichusheji.html-e7b9d1b9.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——shiwuxiaoxi.html-252c8813.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——xiaoxicunchu.html-fc8c4202.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——tongxinmokuai.html-45b767ce.js" as="script"><link rel="prefetch" href="/assets/RocketMQdeshiwuxiaoxi.html-13d23265.js" as="script"><link rel="prefetch" href="/assets/yanshifasongxiaoxi.html-aa37796b.js" as="script"><link rel="prefetch" href="/assets/piliangfasongxiaoxijixiaoxiliebiaofenge.html-0805cda5.js" as="script"><link rel="prefetch" href="/assets/xiaoxifasongyuxiaofei.html-3c22dad5.js" as="script"><link rel="prefetch" href="/assets/xiaoxileixing.html-7a96ed93.js" as="script"><link rel="prefetch" href="/assets/xiaoxiguolv.html-9d81d748.js" as="script"><link rel="prefetch" href="/assets/shunxuxiaofei.html-4a880ddc.js" as="script"><link rel="prefetch" href="/assets/Sentineljichugainian.html-3df61cda.js" as="script"><link rel="prefetch" href="/assets/Sentinelliuliangkongzhi.html-7ef57977.js" as="script"><link rel="prefetch" href="/assets/Sentinelrongduanjiangji.html-6a811c9e.js" as="script"><link rel="prefetch" href="/assets/Sentinelxianliuyuanli.html-46807669.js" as="script"><link rel="prefetch" href="/assets/Sentineljiqunliukong.html-86e8ba3f.js" as="script"><link rel="prefetch" href="/assets/ConfigurationClassPostProcessoryuanmalijie.html-e640fd0d.js" as="script"><link rel="prefetch" href="/assets/SpringzhixingBeanFactoryPostProcessoryuanmalijie.html-ec0c938e.js" as="script"><link rel="prefetch" href="/assets/huancunyizhixingfangansikao.html-64905d2d.js" as="script"><link rel="prefetch" href="/assets/LRUhuancunsuanfa.html-296f757b.js" as="script"><link rel="prefetch" href="/assets/erfenchazhaozhuanti.html-4ea26aa3.js" as="script"><link rel="prefetch" href="/assets/erchashuzhuanti.html-c678693f.js" as="script"><link rel="prefetch" href="/assets/jianzhiofferzhuanti.html-e3757172.js" as="script"><link rel="prefetch" href="/assets/dongtaiguihuazhuanti.html-5dad16fe.js" as="script"><link rel="prefetch" href="/assets/shuangzhizhenzhuanti.html-f767c430.js" as="script"><link rel="prefetch" href="/assets/changyongsuanfajilei.html-dfab3f6f.js" as="script"><link rel="prefetch" href="/assets/paixuzhuanti.html-4f86eda4.js" as="script"><link rel="prefetch" href="/assets/paixusuanfajiqishijianfuzadu.html-8031613b.js" as="script"><link rel="prefetch" href="/assets/zhanheduiliezhuanti.html-a1a684f8.js" as="script"><link rel="prefetch" href="/assets/hongheishuxiangjie.html-3f20cd65.js" as="script"><link rel="prefetch" href="/assets/diguihuisuzhuanti.html-2c524322.js" as="script"><link rel="prefetch" href="/assets/lianbiaozhuanti.html-73ab27ef.js" as="script"><link rel="prefetch" href="/assets/api.html-7580e885.js" as="script"><link rel="prefetch" href="/assets/home.html-286460a5.js" as="script"><link rel="prefetch" href="/assets/plugin.html-c59dd66a.js" as="script"><link rel="prefetch" href="/assets/theme.html-ee7d8238.js" as="script"><link rel="prefetch" href="/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/assets/index.html-ec8b766c.js" as="script"><link rel="prefetch" href="/assets/index.html-9d846cf4.js" as="script"><link rel="prefetch" href="/assets/index.html-596f1991.js" as="script"><link rel="prefetch" href="/assets/index.html-87dad18b.js" as="script"><link rel="prefetch" href="/assets/index.html-3e9ca596.js" as="script"><link rel="prefetch" href="/assets/index.html-16492109.js" as="script"><link rel="prefetch" href="/assets/index.html-4c73e26f.js" as="script"><link rel="prefetch" href="/assets/index.html-7c081a1d.js" as="script"><link rel="prefetch" href="/assets/index.html-2c426692.js" as="script"><link rel="prefetch" href="/assets/index.html-c2b473a2.js" as="script"><link rel="prefetch" href="/assets/index.html-d5163f3d.js" as="script"><link rel="prefetch" href="/assets/index.html-80d7fc4c.js" as="script"><link rel="prefetch" href="/assets/index.html-869bc3d1.js" as="script"><link rel="prefetch" href="/assets/index.html-d79dc309.js" as="script"><link rel="prefetch" href="/assets/index.html-9f1e3344.js" as="script"><link rel="prefetch" href="/assets/index.html-be00baa6.js" as="script"><link rel="prefetch" href="/assets/index.html-32bf1f0a.js" as="script"><link rel="prefetch" href="/assets/index.html-72c06198.js" as="script"><link rel="prefetch" href="/assets/index.html-067ff3ea.js" as="script"><link rel="prefetch" href="/assets/index.html-90c3221c.js" as="script"><link rel="prefetch" href="/assets/index.html-6ce4bbcf.js" as="script"><link rel="prefetch" href="/assets/index.html-340ed2ad.js" as="script"><link rel="prefetch" href="/assets/index.html-5157baa1.js" as="script"><link rel="prefetch" href="/assets/index.html-34f3bc7e.js" as="script"><link rel="prefetch" href="/assets/index.html-fd4b1040.js" as="script"><link rel="prefetch" href="/assets/index.html-dcd7b0d0.js" as="script"><link rel="prefetch" href="/assets/index.html-df6c3b21.js" as="script"><link rel="prefetch" href="/assets/index.html-77bdb0eb.js" as="script"><link rel="prefetch" href="/assets/index.html-831daa4a.js" as="script"><link rel="prefetch" href="/assets/index.html-cea3afbd.js" as="script"><link rel="prefetch" href="/assets/index.html-1e4c8df6.js" as="script"><link rel="prefetch" href="/assets/index.html-338986a4.js" as="script"><link rel="prefetch" href="/assets/index.html-aaa88af3.js" as="script"><link rel="prefetch" href="/assets/index.html-b135fc81.js" as="script"><link rel="prefetch" href="/assets/index.html-d317f47e.js" as="script"><link rel="prefetch" href="/assets/index.html-3440c206.js" as="script"><link rel="prefetch" href="/assets/index.html-3c981a46.js" as="script"><link rel="prefetch" href="/assets/index.html-70a30bad.js" as="script"><link rel="prefetch" href="/assets/index.html-6dae7b0f.js" as="script"><link rel="prefetch" href="/assets/index.html-0c3eae47.js" as="script"><link rel="prefetch" href="/assets/index.html-7b9381d5.js" as="script"><link rel="prefetch" href="/assets/index.html-e4ea30fd.js" as="script"><link rel="prefetch" href="/assets/Dubbochaoshishijianyuanli.html-c1b9dd59.js" as="script"><link rel="prefetch" href="/assets/AQSyuanmalijie——ReentrantLock.html-fd0081ab.js" as="script"><link rel="prefetch" href="/assets/JVMcanshuxiangjie.html-78f74da4.js" as="script"><link rel="prefetch" href="/assets/JVMlajihuishouqi.html-5ea0f7dc.js" as="script"><link rel="prefetch" href="/assets/JVMlajihuishoujichu.html-cae38647.js" as="script"><link rel="prefetch" href="/assets/Javade__heequals()dequbie.html-5c295563.js" as="script"><link rel="prefetch" href="/assets/ThreadLocalyuanmaxiangjie.html-50d38cc8.js" as="script"><link rel="prefetch" href="/assets/LIMITfenyeyouhuachaxun.html-e97d48f8.js" as="script"><link rel="prefetch" href="/assets/MQjianjie.html-2530be4a.js" as="script"><link rel="prefetch" href="/assets/RocketMQkuangjiajichusheji.html-12692bf0.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——shiwuxiaoxi.html-d5fb5acb.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——xiaoxicunchu.html-ca5289bf.js" as="script"><link rel="prefetch" href="/assets/RocketMQyuanmajiexi——tongxinmokuai.html-bfe2c222.js" as="script"><link rel="prefetch" href="/assets/RocketMQdeshiwuxiaoxi.html-c0fbaabd.js" as="script"><link rel="prefetch" href="/assets/yanshifasongxiaoxi.html-c2e01532.js" as="script"><link rel="prefetch" href="/assets/piliangfasongxiaoxijixiaoxiliebiaofenge.html-7072f2cd.js" as="script"><link rel="prefetch" href="/assets/xiaoxifasongyuxiaofei.html-c2c2ce03.js" as="script"><link rel="prefetch" href="/assets/xiaoxileixing.html-f4e7565b.js" as="script"><link rel="prefetch" href="/assets/xiaoxiguolv.html-08501485.js" as="script"><link rel="prefetch" href="/assets/shunxuxiaofei.html-f3f541e1.js" as="script"><link rel="prefetch" href="/assets/Sentineljichugainian.html-24cd046c.js" as="script"><link rel="prefetch" href="/assets/Sentinelliuliangkongzhi.html-8315767f.js" as="script"><link rel="prefetch" href="/assets/Sentinelrongduanjiangji.html-dad7a06a.js" as="script"><link rel="prefetch" href="/assets/Sentinelxianliuyuanli.html-6c847a21.js" as="script"><link rel="prefetch" href="/assets/Sentineljiqunliukong.html-c0a22879.js" as="script"><link rel="prefetch" href="/assets/ConfigurationClassPostProcessoryuanmalijie.html-90e06f73.js" as="script"><link rel="prefetch" href="/assets/SpringzhixingBeanFactoryPostProcessoryuanmalijie.html-56a6dae1.js" as="script"><link rel="prefetch" href="/assets/huancunyizhixingfangansikao.html-9ca1edd8.js" as="script"><link rel="prefetch" href="/assets/LRUhuancunsuanfa.html-39e4501d.js" as="script"><link rel="prefetch" href="/assets/erfenchazhaozhuanti.html-2f705cf5.js" as="script"><link rel="prefetch" href="/assets/erchashuzhuanti.html-5bd79228.js" as="script"><link rel="prefetch" href="/assets/jianzhiofferzhuanti.html-d78589cd.js" as="script"><link rel="prefetch" href="/assets/dongtaiguihuazhuanti.html-a4b7d0f6.js" as="script"><link rel="prefetch" href="/assets/shuangzhizhenzhuanti.html-348e4363.js" as="script"><link rel="prefetch" href="/assets/changyongsuanfajilei.html-66b21b69.js" as="script"><link rel="prefetch" href="/assets/paixuzhuanti.html-5e9e7b55.js" as="script"><link rel="prefetch" href="/assets/paixusuanfajiqishijianfuzadu.html-c2da91c9.js" as="script"><link rel="prefetch" href="/assets/zhanheduiliezhuanti.html-b64ba3d0.js" as="script"><link rel="prefetch" href="/assets/hongheishuxiangjie.html-1632d3a1.js" as="script"><link rel="prefetch" href="/assets/diguihuisuzhuanti.html-9a1cf910.js" as="script"><link rel="prefetch" href="/assets/lianbiaozhuanti.html-fb0ae668.js" as="script"><link rel="prefetch" href="/assets/api.html-f8a12d84.js" as="script"><link rel="prefetch" href="/assets/home.html-435e35af.js" as="script"><link rel="prefetch" href="/assets/plugin.html-ec06ba86.js" as="script"><link rel="prefetch" href="/assets/theme.html-f32621b8.js" as="script"><link rel="prefetch" href="/assets/404.html-a94154d1.js" as="script"><link rel="prefetch" href="/assets/reco-valine-a195b6e9.js" as="script"><link rel="prefetch" href="/assets/giscus-2a044aea-497f0bd4.js" as="script">
    <link rel="preload" href="/assets/style-77970919.css" as="style"><link rel="stylesheet" href="/assets/style-77970919.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper series--no show-catalog"><header class="navbar-container" style="top:0;"><div class="site-brand nav-item"><img class="logo" src="/logo.png" alt="Floweryu"><a href="/" class="site-name can-hide">Floweryu</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link router-link-active" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/RocketMQ/1/" class="link" aria-label="RocketMQ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->RocketMQ<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Java/1/" class="link" aria-label="Java"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Dubbo/1/" class="link" aria-label="Dubbo"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Dubbo<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Sentinel/1/" class="link" aria-label="Sentinel"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Sentinel<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Spring/1/" class="link" aria-label="Spring"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Spring<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/suanfabiji/1/" class="link" aria-label="算法笔记"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法笔记<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/MySQL/1/" class="link" aria-label="MySQL"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->MySQL<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/fenbushi/1/" class="link" aria-label="分布式"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分布式<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/houduan/1/" class="link" aria-label="后端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->后端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhongjianjian/1/" class="link" aria-label="中间件"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->中间件<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/JVM/1/" class="link" aria-label="JVM"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->JVM<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/yuanma/1/" class="link" aria-label="源码"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->源码<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Javajichu/1/" class="link" aria-label="Java基础"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java基础<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/dongtaiguihua/1/" class="link" aria-label="动态规划"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->动态规划<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/paixu/1/" class="link" aria-label="排序"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->排序<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/yuanli/1/" class="link" aria-label="原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->原理<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/suibi/1/" class="link" aria-label="随笔"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->随笔<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/LRU/1/" class="link" aria-label="LRU"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->LRU<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/erfenchazhao/1/" class="link" aria-label="二分查找"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二分查找<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/erchashu/1/" class="link" aria-label="二叉树"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二叉树<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/jianzhioffer/1/" class="link" aria-label="剑指offer"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->剑指offer<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shuangzhizhen/1/" class="link" aria-label="双指针"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->双指针<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhan-duilie/1/" class="link" aria-label="栈-队列"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->栈-队列<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shu/1/" class="link" aria-label="树"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->树<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shujujiegou/1/" class="link" aria-label="数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->数据结构<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/digui/1/" class="link" aria-label="递归"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->递归<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/huisu/1/" class="link" aria-label="回溯"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->回溯<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/lianbiao/1/" class="link" aria-label="链表"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->链表<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/Java/" class="link" aria-label="Java"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/tags/tag1/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/docs/theme-reco/theme" class="link" aria-label="vuepress-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-reco<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blogs/other/guide" class="link" aria-label="vuepress-theme-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-theme-reco<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></header><!----><div class="mobile-menus-container"><nav class="navbar-links mobile"><!--[--><div class="navbar-links__item"><a href="/" class="link router-link-active" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="分类"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="分类"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分类<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/categories/RocketMQ/1/" class="link" aria-label="RocketMQ"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->RocketMQ<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Java/1/" class="link" aria-label="Java"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Dubbo/1/" class="link" aria-label="Dubbo"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Dubbo<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Sentinel/1/" class="link" aria-label="Sentinel"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Sentinel<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/Spring/1/" class="link" aria-label="Spring"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Spring<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/suanfabiji/1/" class="link" aria-label="算法笔记"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法笔记<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/MySQL/1/" class="link" aria-label="MySQL"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->MySQL<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/categories/fenbushi/1/" class="link" aria-label="分布式"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分布式<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="标签"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="标签"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->标签<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/tags/houduan/1/" class="link" aria-label="后端"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->后端<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhongjianjian/1/" class="link" aria-label="中间件"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->中间件<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/JVM/1/" class="link" aria-label="JVM"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->JVM<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/yuanma/1/" class="link" aria-label="源码"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->源码<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/Javajichu/1/" class="link" aria-label="Java基础"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java基础<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/dongtaiguihua/1/" class="link" aria-label="动态规划"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->动态规划<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/paixu/1/" class="link" aria-label="排序"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->排序<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/yuanli/1/" class="link" aria-label="原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->原理<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/suibi/1/" class="link" aria-label="随笔"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->随笔<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/LRU/1/" class="link" aria-label="LRU"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->LRU<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/erfenchazhao/1/" class="link" aria-label="二分查找"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二分查找<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/erchashu/1/" class="link" aria-label="二叉树"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二叉树<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/jianzhioffer/1/" class="link" aria-label="剑指offer"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->剑指offer<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shuangzhizhen/1/" class="link" aria-label="双指针"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->双指针<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/zhan-duilie/1/" class="link" aria-label="栈-队列"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->栈-队列<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shu/1/" class="link" aria-label="树"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->树<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/shujujiegou/1/" class="link" aria-label="数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->数据结构<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/digui/1/" class="link" aria-label="递归"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->递归<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/huisu/1/" class="link" aria-label="回溯"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->回溯<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/tags/lianbiao/1/" class="link" aria-label="链表"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->链表<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/Java/" class="link" aria-label="Java"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Java<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/tags/tag1/1/" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/docs/theme-reco/theme" class="link" aria-label="vuepress-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-reco<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blogs/other/guide" class="link" aria-label="vuepress-theme-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-theme-reco<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><div class="appearance"><span>Appearance</span><span class="xicon-container btn-toggle-dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span></div></div><div class="series-mask"></div><aside class="series-container"><div class="site-brand"><img class="logo" src="/logo.png" alt="Floweryu"><a href="/" class="site-name can-hide">Floweryu</a></div><!--[--><!--]--></aside><!--[--><main class="page-container"><h1 class="page-title">RocketMQ源码解析——服务发现</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Floweryu<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2023-10-30 16:25:00<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->RocketMQ<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->后端 中间件<!--]--></span></span><!----></div><div class="theme-reco-default-content"><div><h2 id="一、服务发现" tabindex="-1"><a class="header-anchor" href="#一、服务发现" aria-hidden="true">#</a> 一、服务发现</h2><p>RocketMQ有下面几个角色</p><p><strong>NameSrv: 注册中心</strong></p><p><strong>Broker: 消息服务器</strong></p><p><strong>Producer: 消息生产者</strong></p><p><strong>Consumer: 消息消费者</strong></p><p>RocketMQ没有使用Zookeeper作为服务的注册中心，而是自研的NameSrv，每个NameSrv都是无关联的节点。</p><p>当消息服务器启动后，会将自己的地址信息等，注册到所有的NameSrv。</p><p><img src="/assets/3fa252bdbb174ebb9315293442e72f91tplv-k3u1fbpfcp-watermark-5174d2ce.png" alt="image.png"></p><p>当Producer和Consumer启动后，会主动连接NameServer，获取可用的Broker列表，并选取Broker进行连接，进行消息发送与拉取。</p><p><img src="/assets/ea2b11fe35bd4ac694ac5bd173d6f54ftplv-k3u1fbpfcp-watermark-20af8b8f.png" alt="image.png"></p><h2 id="二、源码分析" tabindex="-1"><a class="header-anchor" href="#二、源码分析" aria-hidden="true">#</a> 二、源码分析</h2><h3 id="_2-1-路由注册" tabindex="-1"><a class="header-anchor" href="#_2-1-路由注册" aria-hidden="true">#</a> 2.1 路由注册</h3><p>在源码的broker包根目录下，有一个<code>BrokerStartup</code>启动类。</p><p><img src="/assets/df85901275254794a89c0a3dc22ff503tplv-k3u1fbpfcp-watermark-e227f332.png" alt="image.png"></p><p>入口代码如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> public static void main(String[] args) {
     start(createBrokerController(args));
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要进行了两件事：</p><ol start="0"><li>创建BrokerController，用来管理Broker节点</li><li>启动BrokerController</li></ol><p>第一步：创建BrokerController过程，主要是分析配置信息，比如：NameSrv集群的地址表、Broker信的角色信息(Master/Salve)等，并对其进行初始化。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> final BrokerController controller = new BrokerController(
     brokerConfig,
     nettyServerConfig,
     nettyClientConfig,
     messageStoreConfig);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {
     private volatile boolean hasShutdown = false;
     private AtomicInteger shutdownTimes = new AtomicInteger(0);
 
     @Override
     public void run() {
         synchronized (this) {
             log.info(&quot;Shutdown hook was invoked, {}&quot;, this.shutdownTimes.incrementAndGet());
             if (!this.hasShutdown) {
                 this.hasShutdown = true;
                 long beginTime = System.currentTimeMillis();
                 controller.shutdown();
                 long consumingTimeTotal = System.currentTimeMillis() - beginTime;
                 log.info(&quot;Shutdown hook over, consuming total time(ms): {}&quot;, consumingTimeTotal);
             }
         }
     }
 }, &quot;ShutdownHook&quot;));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果代码中使用了线程池，一种优雅的停机方式是注册一个JVM钩子函数，在JVM进程关闭之前，先将线程池关闭，及时释放资源。</p><p>第二步是主要的，启动各种服务。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> public void start() throws Exception {
     if (this.messageStore != null) {
         // 这里的messageStore是在创建controller时初始化的，controller.initialize(); 是DefaultMessageStore类
         // 启动消息存储服务，包括启动Broker的高可用机制；启动以下任务：
         // 1. 启动把内存当中的消息刷到磁盘中的任务
         // 2. 把 commitLog 中的消息分发到 consumerQueue 文件中任务
         // 3. cleanFilesPeriodically(): 清除过期的 commitLog/ consumerQueue 日志文件, 10s
         // 4. checkSelf(): 检查 commitLog/ consumerQueue 的 映射文件，10min
         // 5. 如果 commitLog 锁时间超过了阈值，持久化它的锁信息, 1s
         // 6. isSpaceFull(): 检测磁盘空间是否足够, 10s
         // 需要掌握的java的知识点：scheduleAtFixedRate, RandomAccessFile
         this.messageStore.start();
     }
 
     if (this.remotingServer != null) {
         // 使用Netty暴露Socket服务处理外部请求的调用
         this.remotingServer.start();
     }
 
     if (this.fastRemotingServer != null) {
         // 使用Netty暴露Socket服务处理外部请求的调用
         this.fastRemotingServer.start();
     }
 
     if (this.fileWatchService != null) {
         // 启动文件监听服务
         this.fileWatchService.start();
     }
 
     if (this.brokerOuterAPI != null) {
         // 启动 brokerOuterAPI 也就是 RemotingClient，使得 Broker 可以调用其它方
         this.brokerOuterAPI.start();
     }
 
     if (this.pullRequestHoldService != null) {
         // 启动 pullRequestHoldService 服务用于处理 Consumer 拉取消息
         this.pullRequestHoldService.start();
     }
 
     if (this.clientHousekeepingService != null) {
         // 启动 clientHousekeepingService 服务用于处理 Producer、Consumer、FilterServer 的存活
         this.clientHousekeepingService.start();
     }
 
     if (this.filterServerManager != null) {
         // 启动 filterServerManager 服务用于定时更新 FilterServer
         this.filterServerManager.start();
     }
 
     if (!messageStoreConfig.isEnableDLegerCommitLog()) {
         startProcessorByHa(messageStoreConfig.getBrokerRole());
         handleSlaveSynchronize(messageStoreConfig.getBrokerRole());
         // 注册 Broker 信息到 NameServer
         this.registerBrokerAll(true, false, true);
     }
 
     // 在注册完后，会创建定时任务发送心跳包
     this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
 
         @Override
         public void run() {
             try {
                 // 每10s向NameSrv发送心跳包，NameSrv会定时扫描broker列表，去掉长时间没发送心跳包的broker
                 BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister());
             } catch (Throwable e) {
                 log.error(&quot;registerBrokerAll Exception&quot;, e);
             }
         }
     }, 1000 * 10, Math.max(10000, Math.min(brokerConfig.getRegisterNameServerPeriod(), 60000)), TimeUnit.MILLISECONDS);
 
     if (this.brokerStatsManager != null) {
         // 启动 Broker 中的指标统计
         this.brokerStatsManager.start();
     }
 
     if (this.brokerFastFailure != null) {
         // 启动 Broker 请求列表的过期请求清除任务
         this.brokerFastFailure.start();
     }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用<strong>this.registerBrokerAll</strong>方法注册broker到NameSrv上，在其内部调用<strong>doRegisterBrokerAll</strong>方法。<strong>doRegisterBrokerAll</strong>方法内部调用<strong>this.brokerOuterAPI.registerBrokerAll</strong>方法封装请求头，然后遍历NameSrv列表，向每个NameSrv发起注册请求。</p><blockquote><p>Broker启动时会向集群中所有NameServer发送心跳语句，每隔30s想集群中所有NameServer发送心跳包，NameServer收到心跳包时会更新brokerLiveTable缓存中BrokerLiveInfo的lastUpdateTimeStamp，然后NameServer每隔10s扫描brokerLiveTable，如果连续120s没有收到心跳包，NameServer将移除broker信息同时关闭Socket连接</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> public synchronized void registerBrokerAll(final boolean checkOrderConfig, boolean oneway, boolean forceRegister) {
     TopicConfigSerializeWrapper topicConfigWrapper = this.getTopicConfigManager().buildTopicConfigSerializeWrapper();
 
     if (!PermName.isWriteable(this.getBrokerConfig().getBrokerPermission())
         || !PermName.isReadable(this.getBrokerConfig().getBrokerPermission())) {
         ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable = new ConcurrentHashMap&lt;&gt;();
         for (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) {
             TopicConfig tmp =
                 new TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),
                                 this.brokerConfig.getBrokerPermission());
             topicConfigTable.put(topicConfig.getTopicName(), tmp);
         }
         topicConfigWrapper.setTopicConfigTable(topicConfigTable);
     }
 
     if (forceRegister || needRegister(this.brokerConfig.getBrokerClusterName(),
                                       this.getBrokerAddr(),
                                       this.brokerConfig.getBrokerName(),
                                       this.brokerConfig.getBrokerId(),
                                       this.brokerConfig.getRegisterBrokerTimeoutMills())) {
         doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);
     }
 }
 
 private void doRegisterBrokerAll(boolean checkOrderConfig, boolean oneway,
                                  TopicConfigSerializeWrapper topicConfigWrapper) {
     // 注册broker的信息到NameSrv上
     List&lt;RegisterBrokerResult&gt; registerBrokerResultList = this.brokerOuterAPI.registerBrokerAll(
         this.brokerConfig.getBrokerClusterName(),
         this.getBrokerAddr(),
         this.brokerConfig.getBrokerName(),
         this.brokerConfig.getBrokerId(),
         this.getHAServerAddr(),
         topicConfigWrapper,
         this.filterServerManager.buildNewFilterServerList(),
         oneway,
         this.brokerConfig.getRegisterBrokerTimeoutMills(),
         this.brokerConfig.isCompressedRegister());
 
     if (registerBrokerResultList.size() &gt; 0) {
         RegisterBrokerResult registerBrokerResult = registerBrokerResultList.get(0);
         if (registerBrokerResult != null) {
             if (this.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != null) {
                 this.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());
             }
 
             this.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());
 
             if (checkOrderConfig) {
                 this.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());
             }
         }
     }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入<strong>this.brokerOuterAPI.registerBrokerAll</strong>方法：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> public List&lt;RegisterBrokerResult&gt; registerBrokerAll(
     final String clusterName,
     final String brokerAddr,
     final String brokerName,
     final long brokerId,
     final String haServerAddr,
     final TopicConfigSerializeWrapper topicConfigWrapper,
     final List&lt;String&gt; filterServerList,
     final boolean oneway,
     final int timeoutMills,
     final boolean compressed) {
 
     // 线程安全的List 适用于写操作少的场景，因为每次都要复制副本
     final List&lt;RegisterBrokerResult&gt; registerBrokerResultList = new CopyOnWriteArrayList&lt;&gt;();
     // 获取NameServerAddress列表
     List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();
     if (nameServerAddressList != null &amp;&amp; nameServerAddressList.size() &gt; 0) {
 
         final RegisterBrokerRequestHeader requestHeader = new RegisterBrokerRequestHeader();
         requestHeader.setBrokerAddr(brokerAddr);
         requestHeader.setBrokerId(brokerId);
         requestHeader.setBrokerName(brokerName);
         requestHeader.setClusterName(clusterName);
         requestHeader.setHaServerAddr(haServerAddr);
         requestHeader.setCompressed(compressed);
 
         RegisterBrokerBody requestBody = new RegisterBrokerBody();
         requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);
         requestBody.setFilterServerList(filterServerList);
         final byte[] body = requestBody.encode(compressed);
         final int bodyCrc32 = UtilAll.crc32(body);
         requestHeader.setBodyCrc32(bodyCrc32);
         // 多线程批量发送请求，使用CountDownLatch同步返回
         final CountDownLatch countDownLatch = new CountDownLatch(nameServerAddressList.size());
         for (final String namesrvAddr : nameServerAddressList) {
             brokerOuterExecutor.execute(() -&gt; {
                 try {
                     RegisterBrokerResult result = registerBroker(namesrvAddr, oneway, timeoutMills, requestHeader, body);
                     if (result != null) {
                         registerBrokerResultList.add(result);
                     }
 
                     log.info(&quot;register broker[{}]to name server {} OK&quot;, brokerId, namesrvAddr);
                 } catch (Exception e) {
                     log.warn(&quot;registerBroker Exception, {}&quot;, namesrvAddr, e);
                 } finally {
                     countDownLatch.countDown();
                 }
             });
         }
 
         try {
             // 如果等待一定时间后不再等待，主线程继续执行
             countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);
         } catch (InterruptedException e) {
         }
     }
 
     return registerBrokerResultList;
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来就是发送网络请求的<strong>registerBroker</strong>方法，主要用到基于Netty封装的<strong>NettyRemotingClient</strong>，该方法设置请求的Code为<strong>REGISTER_BROKER(103)</strong> 。</p><p>然后NameSrv会接收到该注册消息，根据Code是<strong>REGISTER_BROKER(103)</strong> 调用<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#registerBroker</code>方法将Broker信息保存起来，使用了读写锁。</p><h4 id="nameserver存储信息" tabindex="-1"><a class="header-anchor" href="#nameserver存储信息" aria-hidden="true">#</a> NameServer存储信息</h4><p>先看看NameServer存储了哪些路由信息，在RouteInfoManager类中：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> private final static long BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2;
 private final ReadWriteLock lock = new ReentrantReadWriteLock();
 private final HashMap&lt;String/* topic */, Map&lt;String /* brokerName */ , QueueData&gt;&gt; topicQueueTable;
 private final HashMap&lt;String/* brokerName */, BrokerData&gt; brokerAddrTable;
 private final HashMap&lt;String/* clusterName */, Set&lt;String/* brokerName */&gt;&gt; clusterAddrTable;
 private final HashMap&lt;String/* brokerAddr */, BrokerLiveInfo&gt; brokerLiveTable;
 private final HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>topicQueueTable：Topic消息队列路由信息，消息发送时根据路由表进行负载均衡。</li><li>brokerAddrTable：Broker基础信息，包含brokerName、所属集群名字，主备Broker地址。</li><li>clusterAddrTable：Broker集群信息，存储集群中所有Broker名称。</li><li>brokerLiveTable：Broker状态信息。NameServer每次收到心跳包时会替换该信息。</li><li>filterServerTable：Broker上的FilterServer列表，用于类模式消息过滤。</li></ul><blockquote><p>RocketMQ一个Topic拥有多个消息队列，一个Broker为每一主题默认创建4个读队列4个写队列。多个Broker组成一个集群，BrokerName由相同的多台Broker组成的Master-Slave架构，brokerId为0代表Master，大于0代表Slave。BrokerLiveInfo中的lastUpdateTimestamp存储上次收到Broker心跳包的时间。</p></blockquote><p>类图如下：</p><p><img src="/assets/2e9e8fc6f7184f26a5fe8eeadeef0b7etplv-k3u1fbpfcp-watermark-e28f1917.png" alt="image.png"></p><p>topicQueueTable、brokerAddrTable运行时结构如下：</p><p><img src="/assets/42f36eeea66e4dbfa65f0176b7c51150tplv-k3u1fbpfcp-watermark-a0e9fd1e.png" alt="image.png"></p><p>brokerLiveTable、clusterAddrTable运行时结构如下：</p><p><img src="/assets/3bfbc50de4bb4954950467a9658bf9aetplv-k3u1fbpfcp-watermark-df02282d.png" alt="image.png"></p><h4 id="nameserver处理心跳包" tabindex="-1"><a class="header-anchor" href="#nameserver处理心跳包" aria-hidden="true">#</a> NameServer处理心跳包</h4><p>RouteInfoManager#registerBroker方法。分为下面几步执行：</p><p><strong>1. clusterAddrTable表维护：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> // 防止并发修改路由表
 this.lock.writeLock().lockInterruptibly();
 // 该broker集群如果不存在，则创建新的
 Set&lt;String&gt; brokerNames = this.clusterAddrTable.computeIfAbsent(clusterName, k -&gt; new HashSet&lt;&gt;());
 brokerNames.add(brokerName);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. brokerAddrTable表维护</strong></p><p>首先从bokerAddrTable根据brokerName尝试获取broker信息，如果不存在，则新建BrokerData并放入到bookerAddrTable中，registerFirst设置为true，表示第一次注册，否则直接替换原来的，registerFirst设置为false，表示非第一次注册</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> BrokerData brokerData = this.brokerAddrTable.get(brokerName);
 if (null == brokerData) {
     // 表示第一次注册
     registerFirst = true;
     brokerData = new BrokerData(clusterName, brokerName, new HashMap&lt;&gt;());
     this.brokerAddrTable.put(brokerName, brokerData);
 }
 Map&lt;Long, String&gt; brokerAddrsMap = brokerData.getBrokerAddrs();
 //Switch slave to master: first remove &lt;1, IP:PORT&gt; in namesrv, then add &lt;0, IP:PORT&gt;
 //The same IP:PORT must only have one record in brokerAddrTable
 // 移除旧的broker映射关系
 Iterator&lt;Entry&lt;Long, String&gt;&gt; it = brokerAddrsMap.entrySet().iterator();
 while (it.hasNext()) {
     Entry&lt;Long, String&gt; item = it.next();
     if (null != brokerAddr &amp;&amp; brokerAddr.equals(item.getValue()) &amp;&amp; brokerId != item.getKey()) {
         log.debug(&quot;remove entry {} from brokerData&quot;, item);
         it.remove();
     }
 }
 
 String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);
 if (MixAll.MASTER_ID == brokerId) {
     log.info(&quot;cluster [{}] brokerName [{}] master address change from {} to {}&quot;,
              brokerData.getCluster(), brokerData.getBrokerName(), oldAddr, brokerAddr);
 }
 // 该broker之前是否注册过
 registerFirst = registerFirst || (null == oldAddr);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. topicQueueTable维护</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> if (null != topicConfigWrapper
     &amp;&amp; MixAll.MASTER_ID == brokerId) {
     if (this.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())
         || registerFirst) {
         ConcurrentMap&lt;String, TopicConfig&gt; tcTable =
             topicConfigWrapper.getTopicConfigTable();
         if (tcTable != null) {
             for (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) {
                 this.createAndUpdateQueueData(brokerName, entry.getValue());
             }
         }
     }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果broker是Master，并且BrokerTopic的信息发生变化或者是初次注册，则需要创建或更新Topic路由信息，为默认Topic自动注册路由信息。</p><p><strong>4. 更新brokerLiveTable，broker存活信息，是路由删除的重要依据</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr,
         new BrokerLiveInfo(
                 System.currentTimeMillis(),
                 topicConfigWrapper.getDataVersion(),
                 channel,
                 haServerAddr));
 if (null == prevBrokerLiveInfo) {
     log.info(&quot;new broker registered, {} HAServer: {}&quot;, brokerAddr, haServerAddr);
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5.注册Broker的过滤器Server地址列表</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> if (filterServerList != null) {
     if (filterServerList.isEmpty()) {
         this.filterServerTable.remove(brokerAddr);
     } else {
         this.filterServerTable.put(brokerAddr, filterServerList);
     }
 }
 
 if (MixAll.MASTER_ID != brokerId) {
     String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);
     if (masterAddr != null) {
         BrokerLiveInfo brokerLiveInfo = this.brokerLiveTable.get(masterAddr);
         if (brokerLiveInfo != null) {
             result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());
             result.setMasterAddr(masterAddr);
         }
     }
 }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一个Broker上会关联多个FilterServer消息过滤器。如果此Broker为从节点，则需要查找该Broker的Master节点信息，并更新对应的masterAddr属性。</p><h4 id="设计亮点" tabindex="-1"><a class="header-anchor" href="#设计亮点" aria-hidden="true">#</a> 设计亮点</h4><p>NameServer每收到一个心跳包，都会更细上述表的信息。上面源码更新各种表信息时，使用了锁粒度较小的读写锁，允许多个消息发送者并发读，保证消息高并发。但同一时刻NameServer只处理一个Broker心跳包，多个心跳包请求穿行执行。这是<strong>读写锁经典使用场景</strong>。</p><h3 id="_2-2-路由删除" tabindex="-1"><a class="header-anchor" href="#_2-2-路由删除" aria-hidden="true">#</a> 2.2 路由删除</h3><p>NameServer会每隔10s来扫描<strong>brokerLiveTable</strong>状态表，如果BrokerLive的lastUpdateTimestamp的时间戳距当前时间超过120s，则认为Broker失效，移除该Broker，同时更新<strong>topicQueueTable、brokerAddrTable、brokerLiveTable、filterServerTable</strong></p><p>RocketMQ有两个触发点触发路由删除：</p><ol><li>NameServer定时扫描brokerLiveTable检测上次心跳包与当前系统时间的时间差，如果时间戳大于120s，则需要移除该Broker信息</li><li>Broker在正常被关闭的情况下，会执行unregisterBroker指令</li></ol><p>下面介绍第一种方式：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> removeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> last <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastUpdateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断是否</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>last <span class="token operator">+</span> <span class="token constant">BROKER_CHANNEL_EXPIRED_TIME</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">closeChannel</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The broker channel expired, {} {}ms&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">BROKER_CHANNEL_EXPIRED_TIME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChannelDestroy</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            removeCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> removeCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RouteInfoManager#onChannelDestroy</strong>方法核心处理：关闭channel，删除与该broker相关的路由信息。</p><p>第一步：申请写锁，将brokerAddress从brokerLiveTable表和filterServerTable表中移除</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：维护brokerAddrTable。从brokerData中的brokerAddr中找到具体的broker，从BrokerData中移除。最后如果移除后BrokerData中不再包含其他Broker，则从brokerAddrTable中移除该brokerName对应条目。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> brokerNameFound <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> removeBrokerName <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerData</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> itBrokerAddrTable <span class="token operator">=</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerNameFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BrokerData</span> brokerData <span class="token operator">=</span> itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> brokerId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerAddr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            brokerNameFound <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove brokerAddr[{}, {}] from brokerAddrTable, because channel destroyed&quot;</span><span class="token punctuation">,</span>
                     brokerId<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        removeBrokerName <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove brokerName[{}] from brokerAddrTable, because channel destroyed&quot;</span><span class="token punctuation">,</span>
                 brokerData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：根据brokerName，从clusterAddrTable表中找到Broker并从集群中移除。移除后集群（brokerNames）中不包含任何Broker，则将该集群从clusterAddrTable中移除</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>brokerNameFound <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> removeBrokerName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> clusterName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brokerNames <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> removed <span class="token operator">=</span> brokerNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerNameFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove brokerName[{}], clusterName[{}] from clusterAddrTable, because channel destroyed&quot;</span><span class="token punctuation">,</span>
                     brokerNameFound<span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove the clusterName[{}] from clusterAddrTable, because channel destroyed and no broker in this cluster&quot;</span><span class="token punctuation">,</span>
                         clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：根据brokerName，遍历所有主题队列，如果队列中包含了当前Broker的队列，则移除。如果topic只包含待移除Broker的队列，从路由表中删除该topic.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>removeBrokerName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> finalBrokerNameFound <span class="token operator">=</span> brokerNameFound<span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> needRemoveTopic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    topicQueueTable<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueDataMap<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueueData</span> old <span class="token operator">=</span> queueDataMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>finalBrokerNameFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove topic[{} {}], from topicQueueTable, because channel destroyed&quot;</span><span class="token punctuation">,</span>
                 topic<span class="token punctuation">,</span> old<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>queueDataMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;remove topic[{}] all queue, from topicQueueTable, because channel destroyed&quot;</span><span class="token punctuation">,</span>
                     topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            needRemoveTopic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    needRemoveTopic<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>topicQueueTable<span class="token operator">::</span><span class="token function">remove</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第五步：释放锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-3-路由发现" tabindex="-1"><a class="header-anchor" href="#_2-3-路由发现" aria-hidden="true">#</a> 2.3 路由发现</h3><p>启动一个生产者很简单，代码如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> DefaultMQProducer producer = new DefaultMQProducer(&quot;Producer&quot;);
 producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);
 producer.start();
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面先告知Producer NameSrv 的地址，紧接着调用了<strong>start</strong>启动生产者。</p><p><img src="/assets/2d9b6c01aa0f40f1ae999213644a4503tplv-k3u1fbpfcp-watermark-49bb9ee2.png" alt="image.png"></p><p>下面会执行到<strong>org.apache.rocketmq.client.impl.factory.MQClientInstance#startScheduledTask</strong>方法，该方法也启动了一些任务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>private void startScheduledTask() {
	......

    // 这里主要看这个方法
    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {

        @Override
        public void run() {
            try {
                // 更新Topic的路由信息
                MQClientInstance.this.updateTopicRouteInfoFromNameServer();
            } catch (Exception e) {
                log.error(&quot;ScheduledTask updateTopicRouteInfoFromNameServer exception&quot;, e);
            }
        }
    }, 10, this.clientConfig.getPollNameServerInterval(), TimeUnit.MILLISECONDS);

	......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要看<strong>updateTopicRouteInfoFromNameServer</strong>这个任务：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>    public void updateTopicRouteInfoFromNameServer() {
        Set&lt;String&gt; topicList = new HashSet&lt;String&gt;();

        // Consumer
        {
            Iterator&lt;Entry&lt;String, MQConsumerInner&gt;&gt; it = this.consumerTable.entrySet().iterator();
            while (it.hasNext()) {
                Entry&lt;String, MQConsumerInner&gt; entry = it.next();
                MQConsumerInner impl = entry.getValue();
                if (impl != null) {
                    Set&lt;SubscriptionData&gt; subList = impl.subscriptions();
                    if (subList != null) {
                        for (SubscriptionData subData : subList) {
                            topicList.add(subData.getTopic());
                        }
                    }
                }
            }
        }

        // Producer
        {
            Iterator&lt;Entry&lt;String, MQProducerInner&gt;&gt; it = this.producerTable.entrySet().iterator();
            while (it.hasNext()) {
                Entry&lt;String, MQProducerInner&gt; entry = it.next();
                MQProducerInner impl = entry.getValue();
                if (impl != null) {
                    Set&lt;String&gt; lst = impl.getPublishTopicList();
                    topicList.addAll(lst);
                }
            }
        }

        for (String topic : topicList) {
            this.updateTopicRouteInfoFromNameServer(topic);
        }
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从生产者和消费者收集Topic信息，然后遍历Topic列表，调用<strong>this.updateTopicRouteInfoFromNameServer(topic)</strong> 方法获取每个Topic的路由信息，保存到<strong>TopicRouteData</strong>中，包含Topic对应的Broker和Queue。然后将Brooker信息保存到<strong>brokerAddrTable</strong>表中。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class TopicRouteData extends RemotingSerializable {
    private String orderTopicConf;
    private List&lt;QueueData&gt; queueDatas;
    private List&lt;BrokerData&gt; brokerDatas;
    private HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;
    ......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里，<strong>生产者就成功从NameSrv获取到了Broker信息</strong>。</p><h2 id="知识点" tabindex="-1"><a class="header-anchor" href="#知识点" aria-hidden="true">#</a> 知识点</h2><ul><li>ReentrantReadWriteLock读写锁使用</li><li>CopyOnWriteArrayList</li><li>CountDownLatch</li><li>HashMap的computeIfAbsent方法</li><li>scheduleAtFixedRate</li><li>RandomAccessFile</li><li>Runtime.getRuntime().addShutdownHook 关闭线程池</li></ul></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->上次编辑于： 10/30/2023, 8:27:49 AM<!--]--></span></span></div></footer><!----><!----></main><!--]--><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#一、服务发现" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="一、服务发现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->一、服务发现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#二、源码分析" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="二、源码分析"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->二、源码分析<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#_2-1-路由注册" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="2.1 路由注册"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2.1 路由注册<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#_2-2-路由删除" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="2.2 路由删除"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2.2 路由删除<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#_2-3-路由发现" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="2.3 路由发现"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2.3 路由发现<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/RocketMQ/RocketMQyuanmajiexi——fuwufaxian.html#知识点" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="知识点"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->知识点<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-9b3d3f60.js" defer></script>
  </body>
</html>
